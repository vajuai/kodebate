package org.example

import ai.koog.agents.core.agent.AIAgent
import ai.koog.agents.core.tools.ToolRegistry
import ai.koog.agents.features.common.message.FeatureMessage
import ai.koog.agents.features.common.message.FeatureMessageProcessor
import ai.koog.agents.features.tracing.feature.Tracing
import ai.koog.agents.mcp.McpToolRegistryProvider
import ai.koog.prompt.executor.clients.openai.OpenAIModels
import ai.koog.prompt.executor.llms.all.simpleOpenAIExecutor
import kotlinx.coroutines.runBlocking
import java.io.BufferedReader
import java.io.InputStreamReader

// æ”¹è¿›çš„å¤©æ°” Agent åˆ›å»ºå‡½æ•°
suspend fun createImprovedWeatherAgent(): AIAgent<String, String> {
    val openAIApiToken = System.getenv("OPENAI_API_KEY") ?: error("OPENAI_API_KEY environment variable not set")
    val owmApiKey = System.getenv("OWM_API_KEY") ?: error("OWM_API_KEY environment variable not set")

    println("ğŸŒ¤ï¸ [ImprovedWeatherAgent] æ­£åœ¨å¯åŠ¨ OpenWeather MCP æœåŠ¡...")
    println("ğŸ”‘ [ImprovedWeatherAgent] OWM_API_KEY: ${owmApiKey.take(10)}...")

    // éªŒè¯ API å¯†é’¥
    if (!validateApiKey(owmApiKey)) {
        throw IllegalArgumentException("âŒ OpenWeather API å¯†é’¥æ— æ•ˆæˆ–æ— æƒé™")
    }

    // å¯åŠ¨ Docker å®¹å™¨
    val process = startMcpContainer(owmApiKey)

    // ç­‰å¾…æ›´é•¿æ—¶é—´ç¡®ä¿æœåŠ¡å®Œå…¨å¯åŠ¨
    println("â³ [ImprovedWeatherAgent] ç­‰å¾… MCP æœåŠ¡å®Œå…¨å¯åŠ¨...")
    Thread.sleep(5000)

    try {
        // è¿æ¥åˆ° MCP æœåŠ¡å™¨
        println("ğŸ”§ [ImprovedWeatherAgent] æ­£åœ¨è¿æ¥åˆ° MCP æœåŠ¡å™¨...")
        val toolRegistry = McpToolRegistryProvider.fromTransport(
            transport = McpToolRegistryProvider.defaultStdioTransport(process)
        )

        println("âœ… [ImprovedWeatherAgent] æˆåŠŸè¿æ¥åˆ° MCP æœåŠ¡å™¨")

        return AIAgent(
            executor = simpleOpenAIExecutor(openAIApiToken),
            systemPrompt = """
                You are a weather assistant that provides accurate weather information.
                
                IMPORTANT INSTRUCTIONS:
                1. Always use the weather tool to get real-time weather data
                2. If the weather tool fails with "unit unavailable" error, inform the user that the weather service is temporarily unavailable
                3. Provide helpful suggestions for alternative weather sources
                4. Be transparent about any technical issues
                
                When weather data is successfully retrieved:
                - Format the information clearly and concisely
                - Include temperature, weather conditions, humidity, and wind if available
                - Use appropriate units (Celsius for temperature, km/h for wind speed)
                
                When weather service fails:
                - Acknowledge the service issue
                - Suggest checking weather.com, AccuWeather, or local weather apps
                - Offer to help with other topics
                
                Always be helpful and provide accurate information only.
            """.trimIndent(),
            llmModel = OpenAIModels.Chat.GPT4o,
            toolRegistry = toolRegistry
        ) {
            install(Tracing) {
                addMessageProcessor(object : FeatureMessageProcessor() {
                    override suspend fun processMessage(message: FeatureMessage) {
                        println("ğŸ” [ImprovedWeatherAgent] Trace: $message")
                    }
                    override suspend fun close() = Unit
                })
            }
        }
    } catch (e: Exception) {
        println("âŒ [ImprovedWeatherAgent] è¿æ¥å¤±è´¥: ${e.message}")

        // è¯»å–å®¹å™¨è¾“å‡ºç”¨äºè¯Šæ–­
        readContainerOutput(process)
        throw e
    }
}

private fun validateApiKey(apiKey: String): Boolean {
    return try {
        val url = java.net.URL("https://api.openweathermap.org/data/2.5/weather?q=London&appid=$apiKey&units=metric")
        val connection = url.openConnection() as java.net.HttpURLConnection
        connection.requestMethod = "GET"
        connection.connectTimeout = 5000
        connection.readTimeout = 10000

        val responseCode = connection.responseCode
        println("ğŸ” [ImprovedWeatherAgent] API å¯†é’¥éªŒè¯å“åº”ç : $responseCode")

        responseCode == 200
    } catch (e: Exception) {
        println("âš ï¸ [ImprovedWeatherAgent] API å¯†é’¥éªŒè¯å¤±è´¥: ${e.message}")
        false
    }
}

private fun startMcpContainer(apiKey: String): Process {
    println("ğŸ³ [ImprovedWeatherAgent] å¯åŠ¨ Docker å®¹å™¨...")

    return ProcessBuilder(
        "docker", "run", "-i", "--rm",
        "-e", "OWM_API_KEY=$apiKey",
        "-e", "DEBUG=1", // å¯ç”¨è°ƒè¯•æ¨¡å¼
        "mcp/openweather"
    ).apply {
        redirectErrorStream(true)
    }.start()
}

private fun readContainerOutput(process: Process) {
    try {
        val reader = BufferedReader(InputStreamReader(process.inputStream))
        val lines = reader.readLines()

        println("ğŸ“‹ [ImprovedWeatherAgent] Docker å®¹å™¨è¾“å‡º:")
        lines.forEach { line ->
            println("   $line")
        }
    } catch (e: Exception) {
        println("âš ï¸ [ImprovedWeatherAgent] æ— æ³•è¯»å–å®¹å™¨è¾“å‡º: ${e.message}")
    }
}

// æµ‹è¯•å‡½æ•°
fun main() = runBlocking {
    try {
        println("ğŸ§ª [ImprovedWeatherAgent] å¼€å§‹æµ‹è¯•æ”¹è¿›çš„å¤©æ°”ä»£ç†...")

        val weatherAgent = createImprovedWeatherAgent()

        println("ğŸŒ¤ï¸ [ImprovedWeatherAgent] å¤©æ°”ä»£ç†åˆ›å»ºæˆåŠŸ")

        // æµ‹è¯•å¤©æ°”æŸ¥è¯¢
        val testQueries = listOf(
            "What's the current weather in London?",
            "å¤©æ°”é¢„æŠ¥ New York",
            "Temperature in Tokyo"
        )

        testQueries.forEach { query ->
            println("\nğŸ“ [ImprovedWeatherAgent] æµ‹è¯•æŸ¥è¯¢: $query")
            try {
                val result = weatherAgent.run(query)
                println("ğŸŒ¤ï¸ [ImprovedWeatherAgent] ç»“æœ: $result")
            } catch (e: Exception) {
                println("âŒ [ImprovedWeatherAgent] æŸ¥è¯¢å¤±è´¥: ${e.message}")
            }
        }

    } catch (e: Exception) {
        println("âŒ [ImprovedWeatherAgent] æµ‹è¯•å¤±è´¥: ${e.message}")
        e.printStackTrace()
    }
}